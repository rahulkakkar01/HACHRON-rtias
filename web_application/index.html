<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Quantum Leap</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Add this to your existing style section in the head: -->
    <style>
        /* Additional styles for the form and dropdown */
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        
        /* Style for the folder colors */
        .folder.green {
            background-color: #4CAF50;
        }
        
        .folder.purple {
            background-color: #9C27B0;
        }

        .warehouse-selector {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #f0f0f0;
        }
        
        .warehouse-selector h3 {
            color: #111827;
            font-size: 1rem;
            font-weight: 500;
            margin: 0 0 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #dashboard-warehouse-select {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        #dashboard-warehouse-select:hover {
            border-color: #4d79ff;
        }
        
        #dashboard-warehouse-select:focus {
            border-color: #4d79ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(77, 121, 255, 0.2);
        }

        /* Additional styles for Recent Audits page */
        .recent-activity, .audit-entries {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
        }
        
        .audit-list li, #audit-list li {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }
        
        .audit-list li:last-child, #audit-list li:last-child {
            border-bottom: none;
        }
        
        .audit-time {
            color: #6b7280;
            font-size: 0.85em;
        }
        
        /* Optional: Add a way to filter audits */
        .audit-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .audit-filters select,
        .audit-filters input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .audit-filters button {
            background-color: #4d79ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
        }

        /* Stock Levels Graph Styles */
        .graphs-container {
            margin-top: 25px;
        }
        
        .graph-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .graph-card {
            background: white;
            border-radius: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            min-width: 350px;
        }
        
        .graph-card h3 {
            margin-top: 0;
            color: #1e1e2d;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .graph-wrapper {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .graph-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .graph-description {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin: 5px 0 0 0;
        }
        
        .insights-panel {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .insights-panel h3 {
            margin-top: 0;
            color: #1e1e2d;
        }
        
        .insights-panel ul {
            padding-left: 20px;
        }
        
        .insights-panel li {
            margin-bottom: 8px;
        }
        
        .section-header {
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin-bottom: 5px;
        }
        
        .section-header p {
            color: #666;
            margin: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .action-buttons button:first-child {
            background: #4d79ff;
            color: white;
        }
        
        .action-buttons button.secondary {
            background: #6c757d;
            color: white;
        }

        /* Update warehouse selector */
        .warehouse-selector {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #f0f0f0;
        }
        
        .warehouse-selector h3 {
            color: #111827;
            font-size: 1rem;
            font-weight: 500;
            margin: 0 0 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #dashboard-warehouse-select {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        /* Recent activity & audit entries */
        .recent-activity, .audit-entries {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
        }
        
        .audit-list li, #audit-list li {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }
        
        .audit-list li:last-child, #audit-list li:last-child {
            border-bottom: none;
        }
        
        .audit-time {
            color: #6b7280;
            font-size: 0.85em;
        }
        
        /* Graph cards */
        .graphs-container {
            margin-top: 25px;
        }
        
        .graph-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .graph-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            border: 1px solid #f0f0f0;
        }
        
        .graph-card h3 {
            margin: 0 0 15px;
            font-size: 1rem;
            color: #111827;
            font-weight: 500;
        }
        
        .graph-wrapper {
            height: 250px;
            background: #f9fafb;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .graph-description {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 10px 0 0;
        }
        
        /* Insights panel */
        .insights-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin: 15px 0 25px;
            border: 1px solid #f0f0f0;
        }
        
        .insights-panel h3 {
            margin: 0 0 15px;
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insights-panel ul {
            padding-left: 20px;
            margin: 0;
        }
        
        .insights-panel li {
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        /* Section headers */
        .section-header {
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin: 0 0 5px;
            font-size: 1.2rem;
            color: #111827;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-header p {
            color: #6b7280;
            margin: 0;
            font-size: 0.95rem;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        /* Result message */
        .result-message {
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i class="fas fa-warehouse"></i> Inventory</h2>
        <ul>
            <li onclick="showSection('dashboard-section')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
            <li onclick="showSection('stock-section')"><i class="fas fa-cubes"></i> Stock Levels</li>
            <li onclick="showSection('audits-section')"><i class="fas fa-history"></i> Recent Audits</li>
            <li onclick="showSection('add-audit-section')"><i class="fas fa-plus-circle"></i> Add Audit</li>
            <li><i class="fas fa-chart-line"></i> Reports </li>
            <li><i class="fas fa-cog"></i> Settings </li>
        </ul>
    </div>
    <div class="main-content">
        <header>
            <h1><i class="fas fa-sync-alt"></i> Real-Time Inventory Audit</h1>
        </header>

        <section id="dashboard-section" class="section">
    <div class="warehouse-selector">
        <h3><i class="fas fa-building"></i> Select Warehouse</h3>
        <select id="dashboard-warehouse-select" onchange="selectWarehouse(this.value)">
            <option value="" disabled selected>Choose a Warehouse</option>
            <option value="Warehouse A">Warehouse A</option>
            <option value="Warehouse B">Warehouse B</option>
            <option value="Warehouse C">Warehouse C</option>
            <option value="Warehouse D">Warehouse D</option>
        </select>
    </div>
    
    <div class="container">
        <div class="audit-box" id="full-inventory">
            <div class="audit-icon"><i class="fas fa-clipboard-check fa-2x"></i></div>
            <h2>Full Physical Inventory</h2>
            <p>Status: <span id="inventory-status">Not Started</span></p>
            <button onclick="window.location.href='start-audit.html'">View</button>
        </div>
        
        <div class="audit-box" id="cycle-counting">
            <div class="audit-icon"><i class="fas fa-chart-pie fa-2x"></i></div>
            <h2>Inventory Analysis</h2>
            <p>Status: <span id="cycle-status">Not Started</span></p>
            <button onclick="window.location.href='inventory-analysis.html'">Start Audit</button>
        </div>
        
        <div class="audit-box" id="spot-checks">
            <div class="audit-icon"><i class="fas fa-search fa-2x"></i></div>
            <h2>Spot Checks</h2>
            <p>Status: <span id="spot-status">Not Started</span></p>
            <div class="button-group">
                <button onclick="startAudit('Spot Checks')">Start Audit</button>
                <button onclick="completeAudit('Spot Checks')" class="secondary">Complete</button>
            </div>
        </div>
        
        <div class="audit-box" id="perpetual-inventory">
            <div class="audit-icon"><i class="fas fa-sync fa-2x"></i></div>
            <h2>Perpetual Inventory</h2>
            <p>Status: <span id="perpetual-status">Active</span></p>
            <p class="description">This is continuously updating.</p>
        </div>
    </div>
</section>

        <section id="stock-section" class="section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Stock Analysis & Visualizations</h2>
                <p>Data-driven insights for inventory management</p>
            </div>
            
            <div class="graphs-container">
                <div class="graph-row">
                    <div class="graph-card">
                        <h3>Demand Distribution</h3>
                        <div class="graph-wrapper">
                            <img src="images/demand_distribution.png" alt="Demand Distribution Histogram" class="graph-image">
                        </div>
                        <p class="graph-description">Distribution of product demand levels across inventory</p>
                    </div>
                    
                    <div class="graph-card">
                        <h3>Demand Categories</h3>
                        <div class="graph-wrapper">
                            <img src="images/demand_categories.png" alt="Demand Categories Pie Chart" class="graph-image">
                        </div>
                        <p class="graph-description">Breakdown of products by demand category</p>
                    </div>
                </div>
                
                <div class="graph-row">
                    <div class="graph-card">
                        <h3>Top Product Categories</h3>
                        <div class="graph-wrapper">
                            <img src="images/category_distribution.png" alt="Category Distribution" class="graph-image">
                        </div>
                        <p class="graph-description">Most common product categories in inventory</p>
                    </div>
                    
                    <div class="graph-card">
                        <h3>Price vs. Demand</h3>
                        <div class="graph-wrapper">
                            <img src="images/price_vs_demand.png" alt="Price vs Demand Relationship" class="graph-image">
                        </div>
                        <p class="graph-description">Relationship between product price and demand level</p>
                    </div>
                </div>
            </div>
            
            <div class="insights-panel">
                <h3><i class="fas fa-lightbulb"></i> Key Insights</h3>
                <ul>
                    <li><strong>Demand Distribution:</strong> <span id="demand-insight">Most products fall in the medium demand category, suggesting balanced inventory allocation.</span></li>
                    <li><strong>Price Sensitivity:</strong> <span id="price-insight">Higher priced items tend to have lower demand, with some notable exceptions.</span></li>
                    <li><strong>Category Performance:</strong> <span id="category-insight">Household Essentials and Dairy are the top performing categories.</span></li>
                </ul>
            </div>
            
            <div class="action-buttons">
                <button id="generate-report-btn" onclick="generateStockReport()">Generate Full Report</button>
                <button id="refresh-data-btn" class="secondary" onclick="refreshStockData()">Refresh Data</button>
            </div>
        </section>

        <section id="audits-section" class="section" style="display: none;">
            <div class="recent-files">
                <h2>Recent Audits</h2>
                
                <!-- Add audit activity log -->
                <div class="recent-activity">
                    <h3><i class="fas fa-history"></i> Audit Activity Log</h3>
                    <ul class="audit-list" id="audit-log">
                        <li>No activity yet.</li>
                    </ul>
                </div>
                
                <!-- Add audit entries list -->
                <div class="audit-entries">
                    <h3><i class="fas fa-clipboard-list"></i> Audit Entries</h3>
                    <ul id="audit-list">
                        <!-- Audits will be inserted here -->
                    </ul>
                </div>
            </div>
        </section>

        <section id="add-audit-section" class="section" style="display: none;">
    <div class="add-audit">
        <h2><i class="fas fa-plus-circle"></i> Add New Audit</h2>
        
        <form id="audit-form" class="card-form">
            <div class="form-grid">
                <div class="form-column">
                    <div class="form-group">
                        <label for="item_name">Product Name</label>
                        <input type="text" id="item_name" placeholder="Enter product name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category</label>
                        <input type="text" id="category" placeholder="E.g. Electronics, Dairy, etc." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Price ($)</label>
                        <input type="number" id="price" placeholder="0.00" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" placeholder="0" required>
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" placeholder="Product brand" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sales_volume">Sales Volume</label>
                        <input type="number" id="sales_volume" placeholder="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="warehouse">Warehouse</label>
                        <select id="warehouse" required>
                            <option value="" disabled selected>Select Warehouse</option>
                            <option value="Warehouse A">Warehouse A</option>
                            <option value="Warehouse B">Warehouse B</option>
                            <option value="Warehouse C">Warehouse C</option>
                            <option value="Warehouse D">Warehouse D</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" required>
                            <option value="" disabled selected>Select Status</option>
                            <option value="In Stock">In Stock</option>
                            <option value="Low Stock">Low Stock</option>
                            <option value="Out of Stock">Out of Stock</option>
                            <option value="Discontinued">Discontinued</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit">Add Audit</button>
                <button type="reset" class="secondary">Reset</button>
            </div>
        </form>
        
        <div id="audit-result-message" class="result-message"></div>
    </div>
</section>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchAudits();
            
            // Add event listener for the form submission
            const auditForm = document.getElementById('audit-form');
            if (auditForm) {
                auditForm.addEventListener('submit', handleAuditFormSubmit);
            } else {
                console.error("Audit form not found in the document");
            }
            
            // Check for audit status updates
            checkAuditStatus();

            // Restore selected warehouse if available
            const selectedWarehouse = localStorage.getItem('selected-warehouse');
            if (selectedWarehouse) {
                const warehouseSelect = document.getElementById('dashboard-warehouse-select');
                if (warehouseSelect) {
                    warehouseSelect.value = selectedWarehouse;
                    selectWarehouse(selectedWarehouse);
                }
            }
        });

        async function handleAuditFormSubmit(event) {
            event.preventDefault();
            
            const resultMessage = document.getElementById('audit-result-message');
            resultMessage.style.display = 'block';
            
            // Format the data to match your blink.json structure
            const newAuditData = {
                index: generateNewIndex(), // Function to generate unique index
                product: document.getElementById('item_name').value,
                category: document.getElementById('category')?.value || "Uncategorized", // Add a category field to your form
                price: parseFloat(document.getElementById('price')?.value || "0"),       // Add a price field to your form
                quantity: parseInt(document.getElementById('quantity').value),
                brand: document.getElementById('brand')?.value || "Generic",             // Add a brand field to your form
                "sales volume": parseInt(document.getElementById('sales_volume')?.value || "0"), // Add sales_volume field
                normalized_demand: calculateNormalizedDemand(
                    parseInt(document.getElementById('sales_volume')?.value || "0")
                ),
                demand_category: determineDemandCategory(
                    parseFloat(document.getElementById('normalized_demand')?.value || "0")
                ),
                inventory_strategy: determineInventoryStrategy(
                    parseFloat(document.getElementById('normalized_demand')?.value || "0")
                ),
                warehouse: document.getElementById('warehouse').value,
                status: document.getElementById('status').value,
                audit_date: new Date().toISOString()
            };
            
            try {
                console.log('Submitting audit data:', newAuditData);
                
                // Save to localStorage for persistence
                saveAuditToLocalStorage(newAuditData);
                
                // Add to the visible audit list
                addAuditToList(newAuditData);
                
                // Update the audit log
                addToAuditLog(`Added audit for ${newAuditData.product}`);
                
                // Try to send to API if it's running
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/audits', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newAuditData)
                    });
                    
                    if (response.ok) {
                        resultMessage.innerHTML = `
                            <div style="color: green; background: #e8f5e9; padding: 10px; border-radius: 4px;">
                                Audit added successfully to the database!
                            </div>`;
                        fetchAudits(); // Refresh the list from server
                    } else {
                        const errorData = await response.json();
                        console.warn('API returned error:', errorData);
                        resultMessage.innerHTML = `
                            <div style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px;">
                                Added locally only. Server message: ${errorData.error || errorData.message || 'Unknown error'}
                            </div>
                            <button id="download-json" style="margin-top: 10px; padding: 8px 16px;">Download JSON Data</button>`;
                            
                        // Add download button functionality
                        document.getElementById('download-json').addEventListener('click', downloadJsonFile);
                    }
                } catch (apiError) {
                    console.warn('API not available:', apiError);
                    resultMessage.innerHTML = `
                        <div style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px;">
                            Added locally only. API not available (${apiError.message})
                        </div>
                        <button id="download-json" style="margin-top: 10px; padding: 8px 16px;">Download JSON Data</button>`;
                        
                    // Add download button functionality
                    document.getElementById('download-json').addEventListener('click', downloadJsonFile);
                }
                
                // Reset the form
                document.getElementById('audit-form').reset();
                
            } catch (error) {
                console.error('Error in audit submission:', error);
                // resultMessage.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">
                    // Error adding audit: ${error.message}</div>`;
            }
        }

        // Helper functions to support the form submission
        function generateNewIndex() {
            // Get existing data
            const storedData = localStorage.getItem('blink_inventory_data');
            const inventoryData = storedData ? JSON.parse(storedData) : [];
            
            // Find the maximum index
            let maxIndex = 0;
            inventoryData.forEach(item => {
                const index = parseInt(item.index);
                if (index > maxIndex) maxIndex = index;
            });
            
            // Return next index
            return maxIndex + 1;
        }

        function calculateNormalizedDemand(salesVolume) {
            // Get highest sales volume for normalization
            const storedData = localStorage.getItem('blink_inventory_data');
            const inventoryData = storedData ? JSON.parse(storedData) : [];
            
            let maxSalesVolume = 50; // Default if no data
            
            inventoryData.forEach(item => {
                const volume = parseInt(item['sales volume'] || 0);
                if (volume > maxSalesVolume) maxSalesVolume = volume;
            });
            
            // Normalize
            return salesVolume / maxSalesVolume;
        }

        function determineDemandCategory(normalizedDemand) {
            if (normalizedDemand >= 0.5) return "High Demand";
            if (normalizedDemand >= 0.3) return "Medium Demand";
            return "Low Demand";
        }

        function determineInventoryStrategy(normalizedDemand) {
            if (normalizedDemand >= 0.5) return "Central warehouse, closest to delivery hubs";
            if (normalizedDemand >= 0.3) return "Regional warehouses, moderate priority";
            return "Stored in secondary locations, replenished as needed";
        }

        function saveAuditToLocalStorage(auditData) {
            // Get existing data
            const storedData = localStorage.getItem('blink_inventory_data');
            const inventoryData = storedData ? JSON.parse(storedData) : [];
            
            // Add new data
            inventoryData.push(auditData);
            
            // Save back to localStorage
            localStorage.setItem('blink_inventory_data', JSON.stringify(inventoryData));
        }

        function downloadJsonFile() {
            const storedData = localStorage.getItem('blink_inventory_data');
            if (!storedData) {
                alert('No data to download');
                return;
            }
            
            // Format the JSON data nicely
            const formattedData = JSON.stringify(JSON.parse(storedData), null, 2);
            
            // Create a blob and download link
            const blob = new Blob([formattedData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'blink.json';
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 0);
        }

        // Function to add an audit to the list without requiring the API
        function addAuditToList(auditData) {
            const auditList = document.getElementById('audit-list');
            
            if (!auditList) return;
            
            const li = document.createElement('li');
            const now = new Date().toLocaleString();
            
            // Create a more detailed audit entry
            li.innerHTML = `
                <div class="audit-info">
                    <strong>${auditData.product}</strong> - 
                    ${auditData.category} - 
                    Qty: ${auditData.quantity} - 
                    ${auditData.warehouse}
                </div>
                <span class="audit-time">${now}</span>
            `;
            
            // Add to the beginning of the list for better visibility
            if (auditList.firstChild) {
                auditList.insertBefore(li, auditList.firstChild);
            } else {
                auditList.appendChild(li);
            }
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
        }

        async function fetchAudits() {
            try {
                const auditList = document.getElementById('audit-list');
                if (!auditList) return;
                
                // Try to get data from API first
                try {
                    let response = await fetch('http://127.0.0.1:5000/api/audits');
                    if (response.ok) {
                        let audits = await response.json();
                        updateAuditList(audits);
                        return;
                    }
                } catch (apiError) {
                    console.warn('API not available, using local storage:', apiError);
                }
                
                // If API fails, get from localStorage
                const storedData = localStorage.getItem('blink_inventory_data');
                if (storedData) {
                    const inventoryData = JSON.parse(storedData);
                    updateAuditList(inventoryData);
                } else {
                    auditList.innerHTML = '<li>No audits found. Add your first audit.</li>';
                }
            } catch (error) {
                console.error('Error fetching audits:', error);
            }
        }

        // New function to update the audit list with consistent formatting
        function updateAuditList(audits) {
            const auditList = document.getElementById('audit-list');
            if (!auditList) return;
            
            auditList.innerHTML = '';
            
            if (audits.length === 0) {
                auditList.innerHTML = '<li>No audits found. Add your first audit.</li>';
                return;
            }
            
            // Sort audits by date (newest first)
            audits.sort((a, b) => {
                const dateA = a.audit_date ? new Date(a.audit_date) : new Date();
                const dateB = b.audit_date ? new Date(b.audit_date) : new Date();
                return dateB - dateA;
            });
            
            // Add each audit to the list
            audits.forEach(audit => {
                const li = document.createElement('li');
                const auditDate = audit.audit_date ? new Date(audit.audit_date).toLocaleString() : new Date().toLocaleString();
                
                li.innerHTML = `
                    <div class="audit-info">
                        <strong>${audit.product || audit.item_name}</strong> - 
                        ${audit.category || 'N/A'} - 
                        Qty: ${audit.quantity} - 
                        ${audit.warehouse}
                    </div>
                    <span class="audit-time">${auditDate}</span>
                `;
                
                auditList.appendChild(li);
            });
        }

        function startAudit(type) {
            // Special case for Cycle Counting - redirect to inventory analysis page
            if (type === 'Cycle Counting') {
                window.location.href = 'inventory-analysis.html';
                return;
            }
            
            // For other audit types
            document.getElementById(type.toLowerCase().replace(/ /g, '-') + '-status').textContent = 'In Progress';
            addToAuditLog(`Started ${type} audit`);
        }

        function completeAudit(type){
            document.getElementById(type.toLowerCase().replace(/ /g, '-') + '-status').textContent = 'Completed';
            addToAuditLog(`Completed ${type} audit`);
        }

        // Add this function to your existing script section
        function checkAuditStatus() {
            // Check cycle counting status first
            const cycleStatus = localStorage.getItem('cycle-counting-status');
            if (cycleStatus) {
                const statusElement = document.getElementById('cycle-status');
                if (statusElement) {
                    statusElement.textContent = cycleStatus;
                    
                    // Add visual indication if completed
                    if (cycleStatus === 'Completed') {
                        statusElement.style.color = 'green';
                        statusElement.style.fontWeight = 'bold';
                    }
                }
            }
            
            // Check if any audit action was recorded
            const auditAction = localStorage.getItem('audit-action');
            if (auditAction) {
                // Get the timestamp or use current time
                let actionTime = new Date().toLocaleString();
                const storedTime = localStorage.getItem('audit-action-time');
                if (storedTime) {
                    actionTime = new Date(storedTime).toLocaleString();
                }
                
                // Add to the audit log if it exists
                addToAuditLog(auditAction);
                
                // Clear the stored action to prevent duplicate entries
                localStorage.removeItem('audit-action');
                localStorage.removeItem('audit-action-time');
            }
        }

        // Add this function to your script section

        function selectWarehouse(warehouseValue) {
            if (!warehouseValue) return;
            
            console.log(`Selected warehouse: ${warehouseValue}`);
            
            // Store the selected warehouse in localStorage
            localStorage.setItem('selected-warehouse', warehouseValue);
            
            // Update any UI elements that should reflect the selected warehouse
            document.querySelectorAll('.warehouse-dependent').forEach(element => {
                element.textContent = element.textContent.replace(/Warehouse [A-D]/, warehouseValue);
            });
            
            // Add to the audit log
            addToAuditLog(`Selected ${warehouseValue}`);
            
            // Optional: Pre-select this warehouse in the Add Audit form
            const auditFormWarehouseSelect = document.getElementById('warehouse');
            if (auditFormWarehouseSelect) {
                auditFormWarehouseSelect.value = warehouseValue;
            }
            
            // You could also load warehouse-specific data here
            // fetchWarehouseData(warehouseValue);
        }

        // Update the function that adds logs to handle the moved audit log section
        function addToAuditLog(message) {
            const auditLog = document.getElementById('audit-log');
            if (!auditLog) return;
            
            const now = new Date().toLocaleString();
            
            // Create a log entry
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="log-message">${message}</div>
                <span class="audit-time">${now}</span>
            `;
            
            // Add to the beginning of the list
            if (auditLog.firstChild) {
                auditLog.insertBefore(li, auditLog.firstChild);
            } else {
                auditLog.appendChild(li);
            }
            
            // Remove "No activity yet" message if it exists
            const noActivityMsg = auditLog.querySelector('li:contains("No activity yet")');
            if (noActivityMsg) {
                auditLog.removeChild(noActivityMsg);
            }
        }

        // Add these functions to your script section:

        function generateStockReport() {
            alert("Generating full stock report. This will be available for download shortly.");
            
            // Here you would typically generate a PDF or other report format
            // For this example, we'll just simulate it with a timeout
            setTimeout(() => {
                const now = new Date().toISOString().split('T')[0];
                alert(`Stock report for ${now} is ready!`);
                
                // Add to audit log
                addToAuditLog(`Generated full stock report`);
            }, 2000);
        }

        function refreshStockData() {
            const refreshBtn = document.getElementById('refresh-data-btn');
            const originalText = refreshBtn.textContent;
            
            refreshBtn.textContent = "Refreshing...";
            refreshBtn.disabled = true;
            
            // Simulate data refresh with a timeout
            setTimeout(() => {
                // Reload the images with a cache-busting parameter
                document.querySelectorAll('.graph-image').forEach(img => {
                    const src = img.src.split('?')[0]; // Remove any existing query params
                    img.src = src + '?t=' + new Date().getTime();
                });
                
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
                
                // Add to audit log
                addToAuditLog(`Refreshed stock analysis data`);
                
                // Show a success message
                alert("Stock data has been refreshed!");
            }, 2000);
        }
    </script>
</body>
</html>
